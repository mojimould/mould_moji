%!TEX root = ../Mould_Analytical_Calculation_Note.tex

%%%%% DOCUMENTCLASS %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[12pt]{scrbook}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{preamble_MACN/packages_MACN}
\input{preamble_MACN/definitions_MACN}

%%%%% GEOMETRY %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\geometry{
  a4paper, % paper size
  twoside,
  centering,
  textwidth={6.5in},
  includehead,  % include the head of the page
%  headheight = 13.6pt,
  includefoot,  % include the foot of the page
  top=15.0truemm,
  bottom=-0.5truemm,
}
%%%%% HEYPERSETUP %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hypersetup{
%  pdfcreationdate=date,
%  pdfcreator={upLaTeX with hyperref}, % creator for PDF subjct field
  pdftitle={モールド関連 -主に幾何学的性質-}, % title for PDF subjct field
  pdfsubject={Mould-Related - Mainly Geometric Properties}, % text for PDF subjct field
  pdfauthor={Kurahashi Nobuaki},  % text for PDF Author field
  pdfkeywords={mould, mold}, % keywords
%  pdfproducer=producer, % dvipdfmx
  linktoc=all,
%  linktocpage=false,   % (if it is true) make page number, not text, be link on TOC, LOF and LOT
  pdfcenterwindow=false, % position the document window center of the screen
  pdffitwindow=true,     % resize document window to fit document size
  bookmarksnumbered=true,
  bookmarksopen=true, %bookmarks open
  pdfstartview={FitH}, % Fit, FitV, FitH, FitB
  pdfpagemode=UseThumbs, % set default mode of PDF display
  unicode=true,
  pdfencoding=unicode,   % PDFDocEncoding or Unicode
  colorlinks=true,     % color links
  linkcolor=ai,      % color of links
  urlcolor=ai,         % color of urls
  citecolor=sora,      % color of citation links
}
%%%%% LINESPREAD %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\linespread{1.15}\selectfont
%%%%% PARINDENT %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setlength\parindent{12pt}
%\def \globalscale {0.83}
%%%%% UNIT LENGTH %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setlength{\unitlength}{1pt}
%%%%% FOOTNOTE %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\interfootnotelinepenalty=10000
\counterwithout{footnote}{chapter}
\def\@makefnmark{\hbox{}\hbox{\@textsuperscript{\normalfont\@thefnmark}}\hbox{}}
\deffootnote[1em]{1em}{1em}{\textsuperscript{\thefootnotemark}}
\renewcommand\footnoterule{%
  \kern3\p@
  \hrule\@width.75\columnwidth
  \kern2.6\p@
}
\makesavenoteenv{twoCtable}
\makesavenoteenv{longtable}
%%%%% DISPLAYBREAK %%%%%%%%%%%%%%%%%%%%%%%%%
\allowdisplaybreaks
%%%%% NAME, AUTOREFNAME %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\footnoteautorefname}{脚注}
\newcommand{\tcb@cnt@hosokuboxautorefname}{補足}
%\newcommand{\tcb@cnt@Columnautorefname}{Column}
%\newcommand{\subfigureautorefname}{\figureautorefname} % subfigure --> figure
%\renewcommand{\tableautorefname}{表}
%\newcommand{\subtableautorefname}{\tableautorefname}
%%%%% HEADER AND FOOTER %%%%%
\pagestyle{fancy}
%\@frontmatterfalse\@backmattertrue\tocloftpagestyle{plainhead}
%\@frontmattertrue\@backmatterfalse\tocloftpagestyle{plainheadfront}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\headrulewidth}{1.5pt}
\renewcommand{\footrulewidth}{0pt}
\newcommand{\commonheadfoot}{
  \fancyhead{}
  \fancyfoot{}
  \fancyfoot[LO]{\tiny\customdate} % footer left fields for main odd pages
  \fancyfoot[RE]{\tiny\customdate} % footer right fields for main even pages
}

\fancypagestyle{emptydate}{\renewcommand{\headrulewidth}{0pt}\commonheadfoot}

\fancypagestyle{front}{
  \commonheadfoot
  \fancyhead[RO]{\thepage}
  \fancyhead[LE]{\thepage}
}
\fancypagestyle{main}{
  \commonheadfoot
  \fancyhead[LO]{\hyperref[sec:\thesection]{{\small\nouppercase\rightmark}}}
  \fancyhead[RO]{$\nicefrac{\thepage\,}{\pageref{LastPage}}$} % header right fields for all main odd pages
  \fancyhead[LE]{$\nicefrac{\thepage\,}{\pageref{LastPage}}$} % header right fields for all main odd pages
  \fancyhead[RE]{\hyperref[\ifx\@chapapp\appendixname app:\else chap:\fi\thechapter]{{\sffamily\bfseries\thechapter.\hskip0.75em\nouppercase\Chaptername}}} % header right fields for all main even pages
}
\fancypagestyle{plainheadfront}{
  \commonheadfoot
  \fancyhead[RO]{\thepage}
  \fancyhead[LE]{\thepage}
}
\fancypagestyle{plainhead}{
  \commonheadfoot
  \fancyhead[RO]{$\nicefrac{\thepage\,}{\pageref{LastPage}}$}
  \fancyhead[LE]{$\nicefrac{\thepage\,}{\pageref{LastPage}}$}
}
\renewcommand*\frontmatter{%
  \if@twoside\cleardoubleoddpage\else\clearpage\fi
  \@frontmattertrue\@mainmatterfalse\@backmatterfalse\pagenumbering{roman}\tocloftpagestyle{plainheadfront}\pagestyle{front}%
}
\renewcommand*\mainmatter{%
  \if@twoside\cleardoubleoddpage\else\clearpage\fi
  \@frontmatterfalse\@mainmattertrue\@backmatterfalse\pagenumbering{arabic}\pagestyle{main}%
}
\renewcommand*\backmatter{%
  \if@openright\cleardoubleoddpage\else\clearpage\fi\@frontmatterfalse\@mainmatterfalse\@backmattertrue\tocloftpagestyle{plainhead}\pagestyle{front}
}
%%%%% WATERMARK %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AddLayersToPageStyle{@everystyle@}{WatermarkLayer}
%%%%% SETLIST %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setlist[enumerate]{listparindent=\parindent, parsep=0pt, partopsep=0pt, topsep=3pt, itemsep=3pt}
%%%%% EQUATION %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\theequation}{\thesection.\arabic{equation}}
\@addtoreset{equation}{section}
%%%%% CAPTION STYLE %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\captionsetup[figure]{%
  width=.8\textwidth,
  format=hang,
  labelfont={bf, sf},
  labelsep={colon},
  labelformat=simple,
  font={small},
}
\captionsetup[lstlisting]{
  justification=raggedright,
  singlelinecheck=false,
  position=above,
  aboveskip=1.1pt,
  belowskip=0pt,
  labelformat={empty},
  labelfont={bf, sf},
  labelsep={space},
  font={bf, large, sf},
  hypcap=false,
}
%%%%% STYLE OF TABLE OF CONTENTS %%%%%
%\renewcommand{\thechapter}{\ifnum\value{chapter}<10 0\fi\arabic{chapter}} % add 0 for chapter num
\setlength{\cftpartnumwidth}{5em} % tocloft
\setlength{\cftchapnumwidth}{1.7em} % tocloft
\renewcommand{\cftchapaftersnum}{.} % tocloft
\renewcommand{\cftsecaftersnum}{.} % tocloft
\renewcommand{\cftsubsecaftersnum}{.} % tocloft
\renewcommand{\cftsubsubsecaftersnum}{.} % tocloft
\AtBeginEnvironment{appendices}{%
  \patchcmd{\part}{\newpage}{\relax}{}{}%
  \pretocmd{\part}{\tocAPartSeparateline}{}{}{}% add page break before parts, except part 1
}
\AfterEndEnvironment{appendices}{%
  \patchcmd{\part}{\tocAPartSeparateline}{\relax}{}{}%
  \pretocmd{\part}{\addtocontents{toc}{\protect\newpage}}{}{}{}% add page break before parts, except the first one
}

\setcounter{tocdepth}{3}
\renewcommand\contentsname{\texorpdfstring{\hbox to 2em{目次}}{目次}}
%%%%% STYLE OF LIST OF FIGURES %%%%%
\renewcommand{\figurename}{図}
\renewcommand{\figureautorefname}{\figurename} % figure --> 図
\renewcommand\listfigurename{\texorpdfstring{\hbox to 3em{図目次}}{図目次}}
%\setcounter{lofdepth}{2}
%\renewcommand*\l@figure{\@dottedtocline{1}{1.5em}{3.2em}}
%\renewcommand*{\l@subfigure}{\@dottedxxxline{\ext@subfigure}{2}{4.7em}{2.3em}}
\renewcommand{\cftfigpresnum}{図\,}
\renewcommand{\cftfigaftersnum}{.} % tocloft
\setlength{\cftfignumwidth}{3.5em}
%%%%% STYLE OF LISTINGS %%%%%
\renewcommand{\lstlistlistingname}{プログラム 目次}
\renewcommand{\lstlistingname}{{\scshape Prg: }}
\AtBeginDocument{
%  \counterwithout{lstlisting}{chapter}
  \renewcommand{\thelstlisting}{}
}
\renewcommand*\l@lstlisting{\@dottedtocline{1}{0.6em}{3.2em}}
\lstdefinelanguage{GcodeBasic}{
  sensitive=true,%
  basicstyle=\small\ttfamily\linespread{1}\selectfont,%
  abovecaptionskip=0pt,
  belowcaptionskip=0pt,
%  aboveskip=0\baselineskip,
%  belowskip=0\baselineskip,
  numbers=left,%
  numbersep=6pt,%
  numberstyle=\ttfamily\scriptsize\color{black!75!},%
  breaklines=true,%
  breakindent=3pt,%
  postbreak=\mbox{\textcolor{blue}{$\hookrightarrow$}\,},%
  frame=single,%
  columns=fixed,%
  basewidth=0.53em,%
  lineskip=-1.2pt,
  comment=[l]{(},%
  commentstyle=\footnotesize\color{black!60!green!100}\slshape,%
  stringstyle={},%
  alsoletter={},%
  keywords={},%
  keywordstyle=\bfseries,%
}
%\lstdefinestyle{Gcode}{%
%  language=GcodeBasic,
%  nolol,
%}
\lstdefinestyle{Gcode-more}{
  language=GcodeBasic,
  nolol,
  morekeywords={[20]IF, GOTO, THEN, WHILE, DO1, DO2, END1, END2},%
  keywordstyle={[20]\fontfamily{pcr}\selectfont\bfseries},%
  emph={G90, G91},
  emphstyle={\bfseries\color{red}},
  emph={[2]G53, G54, G55, G56, G57},
  emphstyle={[2]\bfseries\color{blue}},
  emph={[3]G40, G41, G42, G43, G44},
  emphstyle={[3]\bfseries\color{orange}},
  emph={[4]G00, G01, G02, G03, G31},
  emphstyle={[4]\bfseries\color{magenta}},
  emph={[5]G28, G30},
  emphstyle={[5]\bfseries\color{violet}},
  emph={[6]G04, G13, G49, G58, G65, G80},
  emphstyle={[6]\bfseries\color{cyan}},
  emph={[11]M00, M01, M04, M05, M06, M08, M09,
        M10, M11, M19,
        M30, M32, M33,
        M48, M49,
        M60, M61, M62, M63,
        M71, M72, M73, M74, M78, M79,
        M98, M99,
        M117, M214, M262},
  emphstyle={[11]\fontfamily{pcr}\bfseries\color{yellow!100!green!80!black!100!}},
  emph={[22]SIN, COS, SQRT, FIX, FUP, ROUND, ABS},%
  emphstyle={[22]\fontfamily{pcr}\selectfont\bfseries},%
  emph={[31]P910001, P910002, P220001, P220002, P230001, P230002, P630001, P630002},%
  emphstyle={[31]\bfseries\color{cyan}},%
}
\lstdefinestyle{Gcode-bundle}{
  language=GcodeBasic,
  nolol,
  morekeywords={[120]WHILE, THEN, DO1, DO2, END1, END2},%
  keywordstyle={[120]\fontfamily{pcr}\selectfont\bfseries},%
  emph={[102]},
  emphstyle={[102]\bfseries\color{blue}},
  emph={[111]M10, M11, M19, M30, M32, M33, M48, M49,  M61, M62, M74, M78, M262},
  emphstyle={[111]\fontfamily{pcr}\bfseries\color{yellow!100!green!80!black!100!}},
  emph={[122]SIN, COS, SQRT, FIX, FUP, ABS},%
  emphstyle={[122]\fontfamily{pcr}\selectfont\bfseries},%
}
\lstdefinestyle{Gcode-ren}{
  language=GcodeBasic,
  nolol,
  morekeywords={[220]IF, WHILE, THEN, DO1, DO2, END1, END2},%
  keywordstyle={[220]\fontfamily{pcr}\selectfont\bfseries},%
  emph={[202]},
  emphstyle={[202]\bfseries\color{blue}},
  emph={[211]M0, M5, M19, M32, M33, M99, M214},
  emphstyle={[211]\fontfamily{pcr}\bfseries\color{yellow!100!green!80!black!100!}},
  emph={[222]SIN, COS, TAN, ATAN, SQRT, FIX, FUP, ROUND, DPRNT},%
  emphstyle={[222]\fontfamily{pcr}\selectfont\bfseries},%
}
%%%%% STYLE OF BIBLATEX %%%%%
\renewcommand{\bibname}{\texorpdfstring{\hbox to 4.1em{参考文献}}{参考文献}}
\ExecuteBibliographyOptions{
 sorting=nyt,
 hyperref=true,
 block=nbpar,
 subentry=true,
 citecounter=true,
}
\appto\bibfont{\footnotesize\setstretch{1.1}}
\DeclareFieldFormat{labelnumberwidth}{\mkbibbrackets{#1}\hspace{-6pt}}
%%%%% STYLE OF PART %%%%%
%\renewcommand{\partautorefname}{part}  % part --> part
\renewcommand\partpagestyle{emptydate}
\renewcommand*{\partformat}{\begin{gtfamily}\thepart\end{gtfamily}}
\renewcommand{\thepart}{第\hx\hx\Roman{part}\hx\hx 部}
%\renewcommand*{\addparttocentry}[2]{\addtocentrydefault{part}{#1}{第#2部}}
%%%%% STYLE OF CHAPTER %%%%%
\renewcommand{\chapterautorefname}{章}  % chapter --> 章
\renewcommand\chapterpagestyle{\if@frontmatter plainheadfront\else plainhead\fi}
%%%%% STYLE OF APPENDICES %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\setthesection}{\Alph{section}}
%\renewcommand{\appendixname}{補\hskip0.5em 遺} % appendix --> 補 遺
\renewcommand{\appendixautorefname}{補遺\!} % appendix --> 補遺
%%%%% STYLE OF SECTION %%%%%
%\renewcommand{\sectionautorefname}{節\!} % section --> 節
\setcounter{secnumdepth}{3}
\renewcommand{\subsectionautorefname}{\sectionautorefname} % subsection --> section
\renewcommand{\subsubsectionautorefname}{\sectionautorefname} % subsubsection --> section
%%%%% STYLE OF PARAGRAPH %%%%%%%%%%%%%%%%%%%%%
%for scrbook.cls
\RedeclareSectionCommand[%
  style=section,%
  level=4,%
  indent=0pt,%
  beforeskip=3.25ex \@plus1ex \@minus.2ex,%
  afterskip=0.1ex \@plus.1ex \@minus.1ex,% -1em から変更
  tocindentfollows=subsubsection,%
  tocstyle=section,%
  tocindent=10em,%
  tocnumwidth=5em,%
  font=\raggedsection\normalfont\sectfont\gtfamily\nobreak\sball{blue}~
]{paragraph}
%for book.cls
%\renewcommand\paragraph[1]{%
%  \@startsection{paragraph}{\paragraphnumdepth}{0pt}%
%  {3.25ex \@plus1ex \@minus.2ex}% \@plus, \@minusは伸び縮みできるスペースの長さ
%  {0.1ex\@plus.1ex \@minus.1ex}% ここが正だと改行されて、値だけ垂直スペースが入る
%  {\raggedsection\normalfont\sectfont\gtfamily\nobreak\size@paragraph\sball{blue}~}{#1}\noindent
%}
%%%%% STYLE OF SUBPARAGRAPH %%%%%%%%%%%%%%%%%%%%%
\RedeclareSectionCommand[%
  style=section,%
  level=5,%
  indent=0pt,% \scr@parindent から変更
  beforeskip=0.5ex \@plus1ex \@minus .2ex,% 3.25ex \@plus1ex \@minus .2ex から変更
  afterskip=0.1ex \@plus.1ex \@minus.1ex,% -1em から変更
  tocstyle=section,%
  tocindent=12em,%
  tocnumwidth=6em%
]{subparagraph}
%%%%% TCBSET %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{myheadercolor}{rgb}{0.68, 0.85, 0.90}
\tcbset{%
  %%%%% COLUMNBOX STYLE %%%%%
  Tabularbox/.style={%
  },%
  %%%%% COLUMNBOX STYLE %%%%%
  Columnbox/.style={%
    after title=\hfill\termblue{\Columnname~\thetcbcounter},%
    fonttitle=\gtfamily\bfseries,%
    breakable,%
    enhanced jigsaw,%
    left=.5ex,%
    right=.5ex,%
    bicolor,%
    colbacklower=black!10!white,%
    before upper={%
      \setcounter{GlobalFootnote}{\value{footnote}}% GlobalFootnoteValue=footnoteValue
      \let\oldfootnote=\footnote% \oldfootnote=\footnote
      \def\footnote{\stepcounter{GlobalFootnote}\oldfootnote[\arabic{GlobalFootnote}]}% define \footnote to \footnote using counter GlobalFootnote
      \renewcommand\thempfootnote{\arabic{mpfootnote}}% arabic footnote
    },
    after upper={%
      \setcounter{footnote}{\value{GlobalFootnote}}% footnoteValue=GlobalFootnoteValue
      \let\footnote=\oldfootnote% \footnote=\oldfootnote
    },
  },%
  %%%%% FIGUREBOX STYLE %%%%%
  Figurebox/.style={%
    notitle,%
    height=\textwidth,
%    width=\textwidth,
    center upper,%
    center lower,%
    arc=5pt,%
    outer arc=2pt,%
    boxrule=1pt,%
    boxsep=3mm,%
    valign=center,%
    halign=center,%
    left=0pt,%
    right=0pt,%
    colback=green!3!white,%
    colframe=black!25!white,%
    before={\centering},
  },
  %%%%% HIGHLIGHT MATH STYLE %%%%%
%  highlight math/.style={%
%    enhanced,%
%    arc=2pt,%
%    boxrule=0pt,%
%    frame hidden,%
%    fuzzy halo=1pt with blue,%
%    left=0pt,%
%    right=0pt,%
%    top=.4mm,%
%    bottom=.4mm,%
%    colback=yellow!40!white,%
%  },%
  %%%%% HOSOKUBOX STYLE %%%%%
  hosokubox/.style={%
    title={\termblue{\hosokuname~\thetcbcounter}~},%
    attach title to upper,%
    breakable,%
    enhanced jigsaw,%
    size=fbox,%
    arc=0pt,%
    middle=1mm,%
    colback=hosoku,%
    colframe=hosoku,%
    drop lifted shadow={blue!100!white!50!},%
    skin first is subskin of={enhanced jigsaw}{no shadow},%
    skin middle is subskin of={enhanced jigsaw}{no shadow},%
    skin last is subskin of={enhanced jigsaw}{drop lifted shadow={blue!100!white!50!}},%
    segmentation style={draw=black!50!white},%
    after=\smallskip\noindent{\color{white}},%
  },
  %%%%% TWOCTABLEBOX STYLE %%%%%
  twoCtablebox/.style={%
    breakable,%
    enhanced,%
    fonttitle=\bfseries,%
    fontupper=\small\sffamily,%
    colframe=black!50!black,%
    colbacktitle=blue!10!white,%
    coltitle=black,%
    top=0pt,%
    bottom=0pt,%
    left=0pt,%
    right=0pt,%
    before upper={%
      \setcounter{GlobalFootnote}{\value{footnote}}% GlobalFootnoteValue=footnoteValue
      \let\oldfootnote=\footnote% \oldfootnote=\footnote
      \def\footnote{\stepcounter{GlobalFootnote}\oldfootnote[\arabic{GlobalFootnote}]}% define \footnote to \footnote using counter GlobalFootnote
      \renewcommand\thempfootnote{\arabic{mpfootnote}}% arabic footnote
      \renewcommand{\arraystretch}{1.2}% 行の高さを調整
      \setlength{\LTpre}{-3pt}%
      \setlength{\LTpost}{0pt}%
      \setlength{\LTleft}{0pt}%
      \setlength{\LTright}{0pt}%
      \begin{longtable}{@{}c|l@{\extracolsep{\fill}}c}%
    },%
    after upper={%
      \end{longtable}%
      \setcounter{footnote}{\value{GlobalFootnote}}% footnoteValue=GlobalFootnoteValue
      \let\footnote=\oldfootnote% \footnote=\oldfootnote
    },
  },
}
%%%%% TIKZSET %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tikzset{
  %%%%% SECTIONFORMAT STYLE %%%%%
%  sect/.style={signal, draw, text=white},
%  section/.style={sect, fill=konpeki!100!, signal to=east, inner sep=3pt},
%  subsection/.style={sect, fill=moegi!90!, signal to=nowhere, inner sep=3pt},
%  subsubsection/.style={sect, fill=sssec!100!, signal to=nowhere, inner sep=3pt},
  %%%%% TERMINAL STYLE %%%%%
  terminal/.style={%
    rectangle,%
    minimum size=10pt,%
    rounded corners=1.5mm,%
    thin,%
    draw=black!75,%
    top color=white,%
    font=\fontfamily{pplx},%
    inner sep=3pt,%
    inner xsep=3pt,%
    text height=1ex,%
    text depth=0pt,%
  },
  %%%%% BMATRIX STYLE %%%%%
%  every left delimiter/.style={xshift=.5em},
%  every right delimiter/.style={xshift=-.5em},
%  bmatrix/.style={matrix of math nodes, left delimiter=[, right delimiter=],},
}

\makeatother